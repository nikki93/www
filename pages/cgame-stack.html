<!doctype html>
<html lang="">	
<head>
<meta charset="utf-8"/>
<title>cgame 'Full Stack' Dive - nikhilesh.info</title>	
<meta name="author" content="Nikhilesh Sigatapu">

<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0">

<link href='http://fonts.googleapis.com/css?family=Droid+Sans:700,400|Droid+Sans+Mono' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://www.nikhilesh.info/theme/css/main.css" type="text/css" />

<!--[if lt IE 9]>
    <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->


<link href="http://www.nikhilesh.info/" type="application/atom+xml" rel="alternate" title="nikhilesh.info ATOM Feed" />
</head>

<body>		
<header class="clearfix" role="banner">
    <div class="wrapper">
        <h1 class="huge"><a href="http://www.nikhilesh.info">nikhilesh.info</a></h1>
    </div>
</header>

<div class="wrapper pages">
    <ul class="nav">
 <li><a href="http://www.nikhilesh.info/pages/about.html">about</a></li>  <li><a href="http://www.nikhilesh.info/pages/projects.html">projects</a></li>         <li class="sep">&nbsp;</li>
        <li><a href="http://www.nikhilesh.info/archives.html">archive</a></li>
        <li class="sep">&nbsp;</li>
        <li><a href="mailto:s.nikhilesh@gmail.com">email</a></li>
        <li><a href="https://github.com/nikki93">github</a></li>
    </ul>
</div>

<div role="main" class="content clearfix">	
	<div class="post wrapper">
		<h1>cgame 'Full Stack' Dive</h1>
		<h3>Introduction</h3>
<p>cgame is both a philosophy for how to structure your game and an implementation
of that philosophy, towards the goal of achieving rapid game development times.
Before I dive into the code I'm about to show you, I want to give you a quick
overview of the cgame philosophy, so that you have some context when you look at
it.</p>
<p>For more on cgame beyond this article, check out the
<a href="http://www.nikhilesh.info/files/cgame-poster.pdf">poster</a> or the
<a href="http://www.nikhilesh.info/files/cgame.pdf">paper</a>. Both are a little out of date, notably
missing backwards-compatible save/load and the <code>animation</code> system discussed
below, but still highly informative.</p>
<h3>Philosophy</h3>
<p>In cgame, I strived mainly to uphold three principles that I deemed as important to
rapid game development. These apply throughout the cgame built-in features and
must also readily apply to everything you build in your game. They are:</p>
<ul>
<li><strong>persistence</strong> (save/load)</li>
<li><strong>real-time data editing</strong> in the in-game editor</li>
<li><strong>real-time logic editing</strong> through scripting</li>
</ul>
<p>This needs to extend not just to cgame built-ins, but also to your own game
features, <em>automatically</em>. So if you write the logic for the ghost in Pac-Man,
it must automatically be save/load-ready, in-game-editor-ready and
scripting-ready without you having to put in any effort and without introducing
<a href="https://en.wikipedia.org/wiki/No_Silver_Bullet">accidental complexity</a> on top
of how you would normally code the game.</p>
<p>To that end, cgame chooses an <em>entity-system</em> model of organizing your game
logic. In this model, the basic unit of identity in your game is the <em>entity</em>.
Examples of entities are the player, the Pac-Man ghost, or even a sound or a GUI
button. Usually they have extended identity over time, mutate, interact with
each other or user input, and must be output through drawing or audio.
<a href="http://www.nikhilesh.info/images/cgame-stack-es.png">
    <img style="margin-top: 18px; margin-bottom: 18px;" class="screenshot" src="http://www.nikhilesh.info/images/cgame-stack-es.png"
        alt="I really need some new sprites" />
</a>
Each entity has a unique <em>id</em> (just a unique integer in cgame), and is endowed
with behavior by being put in <em>systems</em>. Each <em>system</em> is meant to endow the
entities it contains with one behavior. For example, the <code>sprite</code> system gives
sprite rendering, while the <code>physics</code> system makes entities fall due to gravity
and collide and bounce around. The <code>transform</code> system is even more basic---it
gives an entity the concept of position, rotation and scale. <code>physics</code> simply
updates the <code>transform</code> of each entity in it, and then later <code>sprite</code> goes on to
read the <code>transform</code> to draw, but <code>sprite</code> and <code>physics</code> never talk to each
other directly and are not even aware of each other. The <code>sprite</code> system doesn't
'care' whether an entity in it is a monster, or a player, or a door---it just
draws it.</p>
<p>Systems store properties per entity and can listen for events. For example, the
<code>sprite</code> system properties define the images for its entities, and it responds
to the <code>draw</code> event to draw them all on screen. When you add a new <code>monster</code>
system you don't care about <code>draw</code>---you'd just set the <code>sprite</code> properties and
it'd happen automatically.</p>
<p>Entities can be added to and removed from systems and their properties in
systems changed on the fly. Each system handles its own save/load. Systems can
be written in C or Lua, and in Lua they have the same interface irrespective of
the language---<code>transform</code> has a function <code>cs.transform.get_position(...)</code> and
<code>animation</code> has the function <code>cs.animation.switch(...)</code>, even though one is in C
and the other in Lua. No wrapper code was written over the C layer, it just is
automatically available.</p>
<p>I think you're now ready to dive in to some code. :) I'll show you a 'vertical
stack' view through the <code>animation</code> system to show you how these things work out
in practice.</p>
<h3>Bottom layer: The <code>sprite</code> interface</h3>
<p><a href="https://github.com/nikki93/cgame/blob/master/src/sprite.h">Here is the header file</a>
defining the interface to the <code>sprite</code> system in cgame. It is written in C
because it needs to be fast and it needs to talk to OpenGL, but that
implementation is in <code>sprite.c</code>, this is just <code>sprite.h</code>. Note how it exposes
<code>sprite_get_*</code> and <code>sprite_set_*</code> to set properties per entity. These are
automatically available in Lua as <code>cs.sprite.get_*</code> and <code>cs.sprite.set_*</code>, no
extra work required. Further, the properties can be set visually in the editor:
<a href="http://www.nikhilesh.info/images/cgame-stack-sprite-props.png">
    <img class="screenshot" src="http://www.nikhilesh.info/images/cgame-stack-sprite-props.png"
        alt="I really need some new sprites" />
</a>
The Lua inspector code just needed a
<a href="https://github.com/nikki93/cgame/blob/master/data/script/cgame/edit_inspector.lua#L658">listing of the C property names</a>,
and it figured out the types by itself through reflection. Lua systems don't
even need an explicit listing, the <code>inspector</code> system simply looks through the
functions it exposes and looks for getters and setters.</p>
<p>The properties relevant to this example are <code>texcell</code> and <code>texsize</code>. The
<code>sprite</code> system uses a single image called the 'atlas' to draw sprites. The
atlas contains all the images you'd want to draw in one large image. <code>texcell</code>
and <code>texsize</code> specify, respectively, the bottom left corner and size of the
rectangle within that atlas to use for the sprite. For example, here is the
atlas used for the game in the above screenshot:</p>
<p><a href="http://www.nikhilesh.info/images/cgame-stack-atlas.png">
    <img style="width: 420px; border-style: solid; border-width: 1px;" class="screenshot" src="http://www.nikhilesh.info/images/cgame-stack-atlas.png"
        alt="I really need some new sprites" />
</a></p>
<p>The <code>sprite</code> implementation
<a href="https://github.com/nikki93/cgame/blob/master/src/sprite.c#L219">uses OpenGL to draw the sprites</a>.
You don't really have to read that code for this example, just note that this is
the abstraction bottom. If you do check it out though, note how easy it all is:
the C code for <code>sprite</code> is just 242 sloc, and the
<a href="https://github.com/nikki93/cgame/blob/master/src/sprite.c#L245">save/load code</a>
is pretty straightforward while providing backwards-comatibility (you can drop
or add properties with defaults, so old version game save files can be loaded).</p>
<p>This is just a special case. When actually making a game, you want to write all
the systems in Lua. Only rarely do you want to write a C system, usually out of
performance considerations or to talk to a C library. So let's look at the Lua layer.</p>
<h3>Middle layer: The <code>animation</code> system</h3>
<p>The <code>animation</code> gives entities a sprite-y look, but the sprite can change over
time quickly. Think Pac-Man's moving jaw. It achieves this by simply changing
the <code>sprite</code> system <code>texcell</code> and <code>texsize</code> for the entity. The <code>animation</code>
system actually does no drawing by itself at all! And this is achieved with the
<code>sprite</code> system knowing nothing about animation either.</p>
<p>In the atlas above you'll see that some of the sprites are very similar and
located next to each other (like the weird red diamond-shaped monster). These
are frames of the same animation. For conveniece, the <code>animation</code> system allows
you to just specify a start sprite and a number of frames and it'll run through
them assuming the are next to each other in the atlas.</p>
<p><a href="https://github.com/nikki93/cgame/blob/master/data/script/cgame/animation.lua">Here is the code</a>
for the <code>animation</code> system. Of main interest is the <code>_enter_frame(...)</code>
function: that's what enters a new frame of the animation and you can see it
call <code>cs.sprite.set_texcell(...)</code>.</p>
<p>The code doesn't specify how to save or load the properties. There is some
<a href="https://github.com/nikki93/cgame/blob/master/data/script/cgame/animation.lua#L122">special inspector code</a>
starting at line 122 because we want a nice way to set animation strips. Systems
get default inspectors for their normal properties (numbers, strings, 2d
vectors, etc.), and they can specify special inspector logic on top of that if
they want. The <code>physics</code> system, for example, allows you to draw the physics
collider shape of an object visually. Note how the <code>curr_anim</code> inspector field
auto-completes the animation name. Oh, and C enum fields auto-complete (using
reflection) too for C enums. :)</p>
<p>The result is that you are able to edit animations in real time! Here's a quick
5-minute video of this in action (with some bonus player logic live-coding in
the end):
<iframe style="margin-top: 24px; marin-bottom: 15px" width="420" height="315" src="https://www.youtube.com/embed/4LV8jJMeuRA" frameborder="0" allowfullscreen></iframe></p>
<p>If you are into web development, you might like
<a href="https://github.com/nikki93/cgame/blob/ld30/data/script/cgame/animation.lua#L131">the way the GUI is specified</a>.
It's sorta CSS-y, but <code>cg.add</code> is just a constructor for an entity, this
particular one happens to be in the <code>gui</code> system and has <code>padding</code> of <code>(0, 0)</code>
and so on. The elements are automatically arranged with a basic version of
Flexbox-y logic.</p>
<h3>Top layer: Using it in a game</h3>
<p>So now that we have an animation system, how do we actually use it in practice?
<a href="https://github.com/nikki93/cgame/blob/master/test/ld30/main.lua#L353">Here's some code</a>
from my game
<a href="http://ludumdare.com/compo/ludum-dare-30/?action=preview&amp;uid=39848">Reminise</a>
for an enemy that sits around and shoots bullets
periodically. The animation is played only when it shoots, which is based on the
countdown timer <code>next</code>. If you scroll down a bit,
<a href="https://github.com/nikki93/cgame/blob/master/test/ld30/main.lua#L368">on line 368</a>
you'll see the code to create a bullet when it shoots, which uses the exact same
<code>cg.add</code> function that was used to create buttons on the inspector GUI, but with
<code>velocity</code> and other bullet-y things. It also uses a <code>prefab</code> which is a way to
save an entity to a file (using the save/load system of course!) and specify it
as a template for a new entity to create. This way I set up the bullet entity
with its <code>sprite</code> or <code>animation</code> properties once visually then can make many
copies of it. Oh and on
<a href="https://github.com/nikki93/cgame/blob/master/test/ld30/main.lua#L379">line 379</a>
<code>cg.add</code> is used for a sound. :)</p>
<p>In this clip from the timelapse of developing Reminisce, you can see me draw the
shooter enemy (it should start playing at 5:54, please seek there if not):
<iframe style="margin-top: 24px; marin-bottom: 15px" width="560" height="315" src="https://www.youtube.com/embed/pZJOkldUVPA?start=354" frameborder="0" allowfullscreen></iframe></p>
<p>The shooter of course also enjoys real-time property and logic editing (for
<code>dir</code> or <code>period</code>, for example) with automatic save/load. The only code that had to be
written was lines
<a href="https://github.com/nikki93/cgame/blob/master/test/ld30/main.lua#L344-L390">344 to 390</a>,
which I'd say is essential complexity.</p>
<h3>Conclusion</h3>
<p>By exploring one particular feature of cgame---animation---all the way from the
bottom C/OpenGL layer to the top-level code and GUI the developer interacts
with, we have seen how cgame provides tools and abstractions for rapid game
development. Development isn't just about adding new functionality, but
iterating on, tweaking, or completely redoing existing functionality, and I
think to that end the three principles introduced in the beginning are key.
cgame upholds these in all of its features and abstraction layers, from sprites,
GUI buttons and sounds to new systems that developers may build with cgame.</p>		
	</div>
</div>

<footer class="clearfix">
    <div class="copy wrapper">
        <p role="contentinfo">© 2013 Nikhilesh Sigatapu<br>
    </div>
</footer>

<script>
var _gaq=[['_setAccount',''],['_trackPageview']];
(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
 g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
 s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
</body>
</html>
