<!doctype html>
<html lang="">	
<head>
<meta charset="utf-8"/>
<title>cgame: 11-line optimization - nikhilesh.info</title>	
<meta name="author" content="Nikhilesh Sigatapu">

<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0">

<link href='http://fonts.googleapis.com/css?family=Droid+Sans:700,400|Droid+Sans+Mono' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://princeton.edu/~sigatapu/theme/css/main.css" type="text/css" />

<!--[if lt IE 9]>
    <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->


<link href="http://princeton.edu/~sigatapu/" type="application/atom+xml" rel="alternate" title="nikhilesh.info ATOM Feed" />
</head>

<body>		
<header class="clearfix" role="banner">
    <div class="wrapper">
        <h1 class="huge"><a href="http://princeton.edu/~sigatapu">nikhilesh.info</a></h1>
    </div>
</header>

<div class="wrapper pages">
    <ul class="nav">
 <li><a href="http://princeton.edu/~sigatapu/pages/about.html">about</a></li>  <li><a href="http://princeton.edu/~sigatapu/pages/projects.html">projects</a></li>         <li class="sep">&nbsp;</li>
        <li><a href="http://princeton.edu/~sigatapu/archives.html">archive</a></li>
        <li class="sep">&nbsp;</li>
        <li><a href="mailto:s.nikhilesh@gmail.com">email</a></li>
        <li><a href="https://github.com/nikki93">github</a></li>
    </ul>
</div>

<div role="main" class="content clearfix">	
	<article>
		<div class="post wrapper">
			<h1>cgame: 11-line optimization</h1>

			<p>I've continued to work on cgame since the independent work
deadline. Most interesting updates:</p>
<ul>
<li><strong>Backwards-compatible save for C systems:</strong> This is more of an
  internal thing, but basically this means changing the format of C
  save/load data (by, for example, adding or removing properties) will
  not make old save files unusable.</li>
<li><strong>Animation system:</strong>
  <a href="https://www.youtube.com/watch?v=4LV8jJMeuRA">Here</a>'s a video if it
  in use.</li>
</ul>
<p>The focus of this blog post, however, is on a <a href="https://github.com/nikki93/cgame/commit/d2e0d17e344c02443c6139e0787490e1c2cf24d9">small change</a>
I made to the code that brought a big performance bonus. C functions
of the form <code>x_y</code> are available as <code>cs.x.y</code> in Lua. This allows
writing <code>cs.transform.rotate(...)</code> for <code>transform_rotate(...)</code>, which
is the same as if transform was actually a Lua system. So Lua scripts
see a consistent API for both Lua and C systems. This was made
possible by the following Lua code:</p>
<div class="highlight"><pre><span class="kd">local</span> <span class="n">systems_mt</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">__index</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">rawget</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
            <span class="kd">local</span> <span class="n">mt</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">__index</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">cg</span><span class="p">[</span><span class="n">k</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s">_&#39;</span> <span class="o">..</span> <span class="n">k2</span><span class="p">]</span>
                <span class="k">end</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nb">setmetatable</span><span class="p">({},</span> <span class="n">mt</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="k">end</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">cg</span><span class="p">.</span><span class="n">systems</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">({},</span> <span class="n">systems_mt</span><span class="p">)</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">cg</span><span class="p">.</span><span class="n">systems</span>
</pre></div>


<p>So the metatable of <code>cs</code> makes it so that accessing a non-existent
member gives a table that concatenates the keys and returns the C
symbol. While reviewing the code today I realized this internal table
was being re-created every access, so I added some memoization:</p>
<div class="highlight"><pre><span class="kd">local</span> <span class="n">system_binds</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">local</span> <span class="n">systems_mt</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">__index</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">rawget</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
            <span class="kd">local</span> <span class="n">bind</span> <span class="o">=</span> <span class="n">system_binds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bind</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
                <span class="n">bind</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">({},</span> <span class="p">{</span>
                    <span class="n">__index</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">cg</span><span class="p">[</span><span class="n">k</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s">_&#39;</span> <span class="o">..</span> <span class="n">k2</span><span class="p">]</span>
                    <span class="k">end</span><span class="p">,</span>
                <span class="p">})</span>
                <span class="n">system_binds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
            <span class="k">end</span>
            <span class="k">return</span> <span class="n">bind</span>
        <span class="k">end</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="k">end</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">cg</span><span class="p">.</span><span class="n">systems</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">({},</span> <span class="n">systems_mt</span><span class="p">)</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">cg</span><span class="p">.</span><span class="n">systems</span>
</pre></div>


<p>The results? Here's a screenshot of the FPS counter when running
<code>test_huge.lua</code> with 2000 blocks before the change:</p>
<p><a href="http://princeton.edu/~sigatapu/images/cgame-optimization-before.png">
    <img class="screenshot" src="http://princeton.edu/~sigatapu/images/cgame-optimization-before.png"
        alt="I really need some new sprites" />
</a></p>
<p>And here it is after:</p>
<p><a href="http://princeton.edu/~sigatapu/images/cgame-optimization-after.png">
    <img class="screenshot" src="http://princeton.edu/~sigatapu/images/cgame-optimization-after.png"
        alt="I really need some new sprites" />
</a></p>
<p>Yup, it actually maxed out the FPS (which is capped at about 60).</p>
			
			
		</div>
	
<div class="meta wrapper">
	<time datetime="2014-07-22T00:00:00" pubdate>Tue 22 July 2014</time>
	<ul class="tag clearfix">
		<li><a href="http://princeton.edu/~sigatapu/category/coding.html">coding</a></li>
	</ul>
</div>	</article>	
</div>

<footer class="clearfix">
    <div class="copy wrapper">
        <p role="contentinfo">Â© 2013 Nikhilesh Sigatapu<br>
    </div>
</footer>

<script>
var _gaq=[['_setAccount',''],['_trackPageview']];
(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
 g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
 s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
</body>
</html>
